# PDF2Anki New Configuration Workflow

This document describes the new per-PDF configuration workflow introduced in this version.

## Overview

The new workflow is centered around a repository-level `documents.yaml` file that maintains metadata and configuration for each PDF document. This enables:

- Per-PDF heuristic-based configuration
- Consistent document metadata tracking
- Flexible configuration layering
- Better organization for multi-document projects

## Quick Start

1. **Scan your documents** to create `documents.yaml`:
   ```bash
   pdf2anki scan-docs --config examples/config.example.yaml
   ```

2. **Review the generation plan**:
   ```bash
   pdf2anki generate --plan
   ```

3. **Generate sample cards** to test prompts:
   ```bash
   pdf2anki generate --sample
   ```

4. **Run full generation**:
   ```bash
   pdf2anki generate --config examples/config.example.yaml
   ```

## Configuration Layering

Configuration is applied in this precedence order (highest to lowest):

1. **CLI overrides** (e.g., `--pdf specific.pdf`)
2. **Explicit per-PDF overrides** in `documents.yaml`
3. **Heuristic defaults** per-PDF (auto-generated by `scan-docs`)
4. **Global defaults** from main config file

## File Structure

```
my-pdf2anki-project/
├── documents.yaml              # Per-PDF configuration (auto-generated)
├── examples/
│   └── config.example.yaml     # Main configuration
├── notes/                      # Note type definitions
│   ├── basic.yaml
│   └── cloze.yaml
├── prompts/                    # Prompt templates
│   ├── key_points_v2.yaml
│   ├── cloze_definitions_v2.yaml
│   └── templates/
│       └── cloze_definitions.j2
├── pdfs/                       # Your PDF files
└── workspace/                  # Generated outputs
    ├── cards.csv
    ├── media/
    └── manifest.json
```

## Key Commands

### `scan-docs`

Discovers PDF files and extracts metadata:

```bash
pdf2anki scan-docs [OPTIONS]
```

**Options:**
- `--config` / `-c`: Configuration file path
- `--documents`: Path to documents.yaml (default: `documents.yaml`)
- `--update` / `--no-update`: Update existing documents.yaml
- `--verbose` / `-v`: Enable verbose output

**What it does:**
- Finds PDFs based on configured input paths
- Extracts metadata (pages, TOC, chapters, DOI, etc.)
- Classifies document types (research_paper, textbook, unknown)
- Generates heuristic configuration defaults
- Creates or updates `documents.yaml`

### `generate`

Generates flashcards using the documents.yaml configuration:

```bash
pdf2anki generate [OPTIONS]
```

**Options:**
- `--config` / `-c`: Configuration file path
- `--documents`: Path to documents.yaml file
- `--plan`: Show generation plan without LLM calls
- `--sample`: Generate sample cards from first chunk only
- `--plan-sample-csv`: Generate sample CSV schema
- `--pdf`: Process specific PDF only
- `--verbose` / `-v`: Enable verbose output

**Modes:**

1. **Plan mode** (`--plan`): Shows what would be generated without LLM calls
2. **Sample mode** (`--sample`): Generates cards from first chunk only for testing
3. **CSV Schema** (`--plan-sample-csv`): Creates sample CSV with all possible fields
4. **Full generation** (default): Complete processing with LLM calls

## Note Types

Note types define the structure of flashcards:

### Basic Note Type (`notes/basic.yaml`)
```yaml
name: "basic"
version: "1.0"
fields:
  front:
    description: "Question or prompt text"
    llm_instructions: "Create a clear, concise question"
    required: true
  back:
    description: "Answer or explanation text"
    llm_instructions: "Provide a complete but concise answer"
    required: true
```

### Cloze Note Type (`notes/cloze.yaml`)
```yaml
name: "cloze"
version: "1.0"
fields:
  cloze_text:
    description: "Text with cloze deletions using {{c1::answer}} syntax"
    required: true
  extra:
    description: "Additional context (optional)"
    required: false
```

## Prompt Templates

Prompt templates use Jinja2 for dynamic content generation:

### Embedded Template
```yaml
name: "key_points"
version: "2.0"
note_type: "basic"
template: |
  Create flashcards from: {{ chunk_text }}
  Max cards: {{ max_cards | default(5) }}
```

### External Template File
```yaml
name: "cloze_definitions"
version: "2.0"
note_type: "cloze"
template_file: "prompts/templates/cloze_definitions.j2"
```

## Chunking Modes

The system supports multiple chunking strategies:

- `pages`: Chunk by page boundaries
- `sections`: Chunk by detected sections/headings
- `paragraphs`: Chunk by paragraph breaks
- `smart`: Intelligent chunking (default)
- `figures`: Chunk based on figures (TODO)
- `highlights`: Chunk based on highlights/annotations (TODO)

## Heuristics

The `scan-docs` command applies heuristics to determine optimal settings:

### Document Type Detection
- **Research Paper**: Has abstract, DOI, references, 5-30 pages
- **Textbook**: Has chapters, TOC, 50+ pages
- **Unknown**: Fallback for unclassified documents

### Configuration Defaults
- **Research Papers**: Smaller chunks (1500 tokens), section-based chunking
- **Textbooks**: Larger chunks (2500 tokens), smart chunking, figure-based strategies
- **Large Documents**: Increased chunk sizes automatically

## CSV Output Schema

The generated CSV includes:

**Note Type Fields:**
- `front`, `back` (basic notes)
- `cloze_text`, `extra` (cloze notes)

**Provenance Fields:**
- `id`, `note_type`, `deck`, `tags`, `media`
- `source_pdf`, `page_start`, `page_end`, `section`
- `llm_model`, `llm_version`, `strategy`, `template_version`
- `created_at`, `updated_at`
- `core_concept`, `longtext`, `original_text`, `my_notes`

## Strategy Registry

Strategies are registered and can be extended:

```python
from pdf2anki.strategy_registry import get_strategy_registry

registry = get_strategy_registry()
registry.register_strategy("custom_strategy", custom_factory_function)
```

## TODO Items

The following features are stubbed and need implementation:

1. **LLM Integration**: Replace mock responses with actual LLM calls
2. **Configuration Layering**: Complete the `get_effective_config` logic
3. **Figure Chunking**: Implement figure-based chunking mode
4. **Highlights Chunking**: Implement highlights-based chunking mode
5. **Token Truncation**: Implement proper token-aware text truncation
6. **Cache Integration**: Add caching for LLM responses
7. **Error Handling**: Add comprehensive error handling and recovery

## Migration from Old Workflow

To migrate from the old workflow:

1. Copy your existing config to `examples/config.example.yaml`
2. Run `pdf2anki scan-docs` to create `documents.yaml`
3. Review and adjust per-PDF settings in `documents.yaml`
4. Use `pdf2anki generate` instead of the old `preprocess` command

**Migration Note**: The `preprocess` command has been removed. Legacy configuration files 
will be automatically translated with deprecation warnings. The old top-level configuration 
keys (like `llm`, `strategies`) are now organized under `pipeline` and `generate` sections.